name: Moneyball Dojo Daily Predictions

# ============================================================================
# WORKFLOW CONFIGURATION v4 â€” FULL AUTOMATION
# ============================================================================
# run_daily.py v4 ãŒã™ã¹ã¦ã‚’å†…éƒ¨ã§å‡¦ç†:
# 1. MLB Stats API ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾— + å…¨9ãƒ¢ãƒ‡ãƒ«ã§äºˆæ¸¬
# 2. Anthropic API ã§ EN/JA è¨˜äº‹ã‚’è‡ªå‹•ç”Ÿæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
# 3. Google Sheets v2 ã‚¹ã‚­ãƒ¼ãƒã«è‡ªå‹•æ›¸ãè¾¼ã¿
# 4. ã‚¨ãƒ©ãƒ¼æ™‚ã¯ Slack + GitHub Issues ã«é€šçŸ¥
#
# è¿½åŠ ã‚¸ãƒ§ãƒ–:
# - update-results: æ¯æ—¥15:00 UTC ã«çµæœã‚’å–å¾—
# - retrain-models: æ¯é€±æœˆæ›œã«ãƒ¢ãƒ‡ãƒ«å†å­¦ç¿’
# - sync-public: äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªã«åŒæœŸ

on:
  schedule:
    - cron: '0 8 * * *'   # äºˆæ¸¬ç”Ÿæˆ (08:00 UTC)
    - cron: '0 15 * * *'  # çµæœå–å¾— (15:00 UTC)
    - cron: '0 0 * * 1'   # æ¯é€±æœˆæ›œå†å­¦ç¿’
    - cron: '0 1 * * 1'   # æ¯é€±æœˆæ›œ é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ (01:00 UTC)

  workflow_dispatch:
    inputs:
      action:
        description: 'Action to run (predict/update/retrain/review)'
        required: true
        default: 'predict'
      test_mode:
        description: 'Run in test mode (true/false)'
        required: false
        default: 'false'

permissions:
  contents: write
  issues: write

env:
  PYTHON_VERSION: '3.10'
  LOG_LEVEL: 'INFO'

jobs:
  # ========================================================================
  # JOB 0: UPDATE RESULTS (Every day at 15:00 UTC)
  # ========================================================================
  update-results:
    name: Update Historical Data
    if: github.event.schedule == '0 15 * * *' || github.event.inputs.action == 'update'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Update daily results
        env:
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
        run: python update_daily_results.py

      - name: Commit and push updated data
        run: |
          git config --global user.name "Moneyball Dojo Bot"
          git config --global user.email "bot@moneyball-dojo.ai"
          git add data/*.csv
          git commit -m "auto: Update historical data [skip ci]" || echo "No changes"
          git push

      - name: Slack notification (results updated)
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ğŸ“¥ çµæœå–å¾—å®Œäº† â€” status: ${{ job.status }}\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ãƒ­ã‚°>"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

  # ========================================================================
  # JOB 0.5: RETRAIN MODELS (Every Monday)
  # ========================================================================
  retrain-models:
    name: Retrain ML Models
    if: github.event.schedule == '0 0 * * 1' || github.event.inputs.action == 'retrain'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Retrain all models
        run: python train_all_models.py

      - name: Commit and push updated models
        run: |
          git config --global user.name "Moneyball Dojo Bot"
          git config --global user.email "bot@moneyball-dojo.ai"
          git add models/*.pkl model.pkl
          git commit -m "auto: Retrain models with latest data [skip ci]" || echo "No changes"
          git push

      - name: Slack notification (retrain complete)
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ğŸ”„ ãƒ¢ãƒ‡ãƒ«å†å­¦ç¿’å®Œäº† â€” status: ${{ job.status }}\n9ãƒ¢ãƒ‡ãƒ«æ›´æ–°æ¸ˆã¿ï¼ˆleak-free rolling + isotonic calibrationï¼‰\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ãƒ­ã‚°>"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

  # ========================================================================
  # JOB 0.7: WEEKLY REVIEW (Every Monday at 01:00 UTC)
  # ========================================================================
  weekly-review:
    name: Weekly Review
    if: github.event.schedule == '0 1 * * 1' || github.event.inputs.action == 'review'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate weekly review
        run: python weekly_review_generator.py

      - name: Commit and push weekly review
        run: |
          git config --global user.name "Moneyball Dojo Bot"
          git config --global user.email "bot@moneyball-dojo.ai"
          git add output/weekly/
          git commit -m "auto: Weekly review $(date -u +'%Y-%m-%d') [skip ci]" || echo "No changes"
          git push

      - name: Upload weekly review
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: weekly-review
          path: output/weekly/
          retention-days: 90

      - name: Slack notification (weekly review)
        if: env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ğŸ“Š Weekly Review generated â€” check output/weekly/ for EN+JA reports"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

  # ========================================================================
  # JOB 1: FULL AUTOMATED PIPELINE (run_daily.py v4)
  # ========================================================================
  daily-pipeline:
    name: Daily Prediction Pipeline
    if: github.event.schedule == '0 8 * * *' || github.event.inputs.action == 'predict'
    runs-on: ubuntu-latest
    outputs:
      prediction_count: ${{ steps.run.outputs.count }}
      high_confidence_count: ${{ steps.run.outputs.high_confidence }}
      pipeline: ${{ steps.run.outputs.pipeline }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run full prediction pipeline (v4)
        id: run
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          MLB_API_KEY: ${{ secrets.MLB_API_KEY }}
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
          TEST_MODE: ${{ github.event.inputs.test_mode }}
          LOG_LEVEL: ${{ env.LOG_LEVEL }}
        run: |
          TARGET_DATE=$(date -u +'%Y-%m-%d')
          echo "Target date: $TARGET_DATE"

          # run_daily.py v4: äºˆæ¸¬ + APIè¨˜äº‹ç”Ÿæˆ + Sheetsæ›¸ãè¾¼ã¿ + ã‚¨ãƒ©ãƒ¼é€šçŸ¥
          if python run_daily.py "$TARGET_DATE"; then
            echo "pipeline=production" >> $GITHUB_OUTPUT

            DATED_DIR="output/$(echo $TARGET_DATE | tr -d '-')"
            if [ -f "$DATED_DIR/predictions.csv" ]; then
              cp "$DATED_DIR/predictions.csv" output/daily_predictions.csv
            fi
          else
            echo "run_daily.py failed â€” falling back to demo"
            python data_pipeline_demo.py \
              --output-dir ./output \
              --season 2024 \
              --test-mode ${TEST_MODE:-false} || true
            echo "pipeline=demo" >> $GITHUB_OUTPUT
          fi

          # Count predictions
          if [ -f output/daily_predictions.csv ]; then
            PRED_COUNT=$(wc -l < output/daily_predictions.csv)
            echo "count=$((PRED_COUNT - 1))" >> $GITHUB_OUTPUT
            HIGH_CONF=$(grep -c -E "STRONG|HIGH" output/daily_predictions.csv || echo "0")
            echo "high_confidence=$HIGH_CONF" >> $GITHUB_OUTPUT
          else
            echo "count=0" >> $GITHUB_OUTPUT
            echo "high_confidence=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload all outputs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-predictions
          path: |
            output/daily_predictions.csv
            output/*/digest_*.md
            output/*/twitter_*.txt
            output/*/predictions_*.json
            output/*/pipeline_errors.log
          retention-days: 30

      - name: Log prediction summary
        run: |
          echo "=== Daily Pipeline v4 Summary ==="
          echo "Pipeline: ${{ steps.run.outputs.pipeline }}"
          echo "Predictions: ${{ steps.run.outputs.count }}"
          echo "High Confidence: ${{ steps.run.outputs.high_confidence }}"
          echo "Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

  # ========================================================================
  # JOB 2: LOGGING AND NOTIFICATIONS
  # ========================================================================
  log-results:
    name: Log Results and Notifications
    needs: [daily-pipeline]
    runs-on: ubuntu-latest
    if: always() && needs.daily-pipeline.result != 'skipped'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate execution summary
        run: |
          cat > execution_summary.txt << EOF
          =============================================================================
          MONEYBALL DOJO v4 â€” DAILY EXECUTION SUMMARY
          =============================================================================

          Execution Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}

          PIPELINE RESULTS:
          - Daily Pipeline: ${{ needs.daily-pipeline.result }}
          - Mode: ${{ needs.daily-pipeline.outputs.pipeline }}

          PREDICTION SUMMARY:
          - Total Predictions: ${{ needs.daily-pipeline.outputs.prediction_count }}
          - High Confidence Picks: ${{ needs.daily-pipeline.outputs.high_confidence_count }}

          AUTOMATION STATUS:
          - Anthropic API Articles: Integrated in run_daily.py
          - Google Sheets Upload: Integrated in run_daily.py
          - Public Repo Sync: Triggered via workflow_run

          =============================================================================
          EOF
          cat execution_summary.txt

      - name: Upload execution summary
        uses: actions/upload-artifact@v4
        with:
          name: execution-summary
          path: execution_summary.txt
          retention-days: 30

      # NOTE: æŠ•ç¨¿ç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯run_daily.pyå†…ã‹ã‚‰ç›´æ¥Slackã«é€ä¿¡æ¸ˆã¿ã€‚
      # ã“ã“ã§ã¯GitHub Actionså´ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã ã‘é€šçŸ¥ã™ã‚‹ã€‚
      - name: Slack notification (pipeline status)
        if: always() && env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "GitHub Actions: pipeline=${{ needs.daily-pipeline.outputs.pipeline }}, status=${{ needs.daily-pipeline.result }} â€” <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|logs>"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

      - name: Create GitHub Issue for daily review
        if: needs.daily-pipeline.outputs.high_confidence_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('execution_summary.txt', 'utf8');
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Daily Predictions â€” ${new Date().toISOString().split('T')[0]}`,
              body: `## Daily Predictions Report\n\n\`\`\`\n${summary}\n\`\`\`\n\n### Checklist\n- [ ] Review predictions\n- [ ] Verify articles published\n- [ ] Monitor game results`,
              labels: ['predictions', 'daily-report']
            });

  # ========================================================================
  # FAILURE NOTIFICATION
  # ========================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [daily-pipeline]
    if: failure() && needs.daily-pipeline.result != 'skipped'

    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Pipeline Failed â€” ${new Date().toISOString().split('T')[0]}`,
              body: `## Pipeline Execution Failed\n\nRun: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nPlease investigate and fix the issue.`,
              labels: ['bug', 'urgent']
            });

      - name: Slack failure alert
        if: env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ğŸš¨ Moneyball Dojo Pipeline FAILED â€” https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

# ============================================================================
# REQUIRED SECRETS
# ============================================================================
# 1. CLAUDE_API_KEY        â€” Anthropic API key (â†’ ANTHROPIC_API_KEY in run_daily.py)
# 2. GOOGLE_SHEETS_CREDENTIALS â€” Service account JSON
# 3. GOOGLE_SHEETS_ID      â€” Spreadsheet ID
# 4. SLACK_WEBHOOK          â€” (Optional) Slack notifications
# 5. MLB_API_KEY            â€” (Optional) MLB Stats API
# 6. PUBLIC_REPO_TOKEN      â€” (Optional) For sync_public_repo.yml
# 7. ODDS_API_KEY           â€” (Optional) The Odds API for real market odds
